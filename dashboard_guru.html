const scriptURL = "https://script.google.com/macros/s/AKfycbx3QrtXq3gxCgm46jTZTJjh5qjK1kw1ZQxqP0lc43ka6CKg5BkCG3UF9aEGzO7pDzR98Q/exec";

document.addEventListener("DOMContentLoaded", () => {
  fetchInventaris();

  document.getElementById("formPeminjaman").addEventListener("submit", ajukanPeminjaman);
});

function fetchInventaris() {
  fetch(`${scriptURL}?action=viewInventaris`)
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById("tabelInventaris");
      if (data.length === 0) {
        container.innerHTML = "Tidak ada data.";
        return;
      }

      let html = "<table><tr>";
      data[0].forEach(h => html += `<th>${h}</th>`);
      html += "</tr>";

      for (let i = 1; i < data.length; i++) {
        html += "<tr>";
        data[i].forEach(cell => html += `<td>${cell}</td>`);
        html += "</tr>";
      }

      html += "</table>";
      container.innerHTML = html;
    })
    .catch(err => {
      document.getElementById("tabelInventaris").innerText = "Gagal memuat data.";
      console.error(err);
    });
}

function ajukanPeminjaman(e) {
  e.preventDefault();
  const nama_barang = document.getElementById("nama_barang").value.trim();
  const jumlah = document.getElementById("jumlah").value;
  const tanggal_pinjam = document.getElementById("tanggal_pinjam").value;
  const tanggal_kembali = document.getElementById("tanggal_kembali").value;
  const nama_peminjam = localStorage.getItem("username") || "Guru";

  const today = new Date().toISOString().split("T")[0];

  const url = `${scriptURL}?action=ajukanPeminjaman&tanggal_pengajuan=${today}&nama_peminjam=${encodeURIComponent(nama_peminjam)}&nama_barang=${encodeURIComponent(nama_barang)}&jumlah=${jumlah}&tanggal_pinjam=${tanggal_pinjam}&tanggal_kembali=${tanggal_kembali}`;

  fetch(url)
    .then(res => res.json())
    .then(result => {
      document.getElementById("message").innerText = result.message;
      if (result.status === "success") {
        document.getElementById("formPeminjaman").reset();
      }
    })
    .catch(err => {
      console.error(err);
      document.getElementById("message").innerText = "Gagal mengirim pengajuan.";
    });
}
